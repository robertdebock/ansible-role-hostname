---
# tasks file for hostname

- name: import assert.yml
  import_tasks: assert.yml
  run_once: yes
  delegate_to: localhost

- name: install requirements
  ansible.builtin.package:
    name: "{{ hostname_requirements }}"
    state: present

- name: set hostname
  ansible.builtin.hostname:
    name: "{{ hostname }}"
  notify:
    - reboot
    - gather facts
  when:
    - ansible_connection != "community.docker.docker"

- name: ansible-role-hostname | gather facts on newly created machines
  setup:
  register: hostsfacts

- name: ansible-role-hostname | host file configuration for ipv4
  include_tasks: host.yml
  vars:
    host: "{{ hostname }}"
  loop: "{{ hostsfacts.ansible_facts.ansible_all_ipv4_addresses | default([]) | reject('match', '^.*\\.1$') }}" # exclude addresses that endswith 1 because they usually
  loop_control:
    loop_var: ip
  when:
    - ansible_connection != "community.docker.docker"
    - handle_ipv4

- name: ansible-role-hostname | host file configuration for ipv6
  include_tasks: host.yml
  vars:
    host: "{{ hostname }}"
  loop: "{{ hostsfacts.ansible_facts.ansible_all_ipv6_addresses | default([]) }}"
  loop_control:
    loop_var: ip
  when:
    - ansible_connection != "community.docker.docker"
    - handle_ipv6
